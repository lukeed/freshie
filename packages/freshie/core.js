import{resolve,join,relative,parse}from"path";import{promises,existsSync,statSync,readFileSync}from"fs";import i$6 from"kleur";import{klona}from"klona";import{totalist}from"totalist";import w$3 from"escalade";import B from"route-sort";import{gzipSync}from"zlib";async function f$4(e){return promises.rm(e,{recursive:!0,force:!0})}const x$1=promises.readdir,n$1=existsSync;promises.writeFile;const u$1=promises.readFile;function a$2(e){return n$1(e)&&statSync(e).isDirectory()}function d$3(e,t){return e.find((e=>t.test(e)))}function e$4(e,t=!0){return null==e?t:!/(0|false)/.test(e)}function m(e,t){const r=e.cwd=resolve(e.cwd||".");e.dest=join(r,e.destDir="build"),e.src=join(r,e.srcDir="src"),e.isProd=t,e.src=a$2(e.src)?e.src:r,e.ssr=e$4(e.ssr,!0),e.minify=e$4(e.minify,t),e.sourcemap=e$4(e.sourcemap,!t)}const t=i$6.bold("[freshie]"),c$1=" ".repeat(10);function e$3(e,r){console.log(i$6[e](t),r.includes("\n")?r.replace(/(\r?\n)/g,"$1"+c$1):r)}e$3.bind(0,"white");const l$2=e$3.bind(0,"cyan"),d$2=e$3.bind(0,"green"),x=e$3.bind(0,"yellow"),i$5=e$3.bind(0,"red");function a$1(e,t=1){i$5(e instanceof Error?e.stack:e),process.exit(t)}const b=i$6.magenta,f$3=i$6.bold().white;var o$2;function W(e){return e&&"index"!==e?"["!==e[0]?[0,e]:"..."===(e=e.slice(1,-1)).substring(0,3)?[2,"*",e.substring(3)]:[1,":"+e]:[0,""]}function _(e){let{dir:t,name:r}=parse(e),n="/",i=null,s=0,o=[...t.split(/[\\\/]+/g),r];for(let e,t=0;t<o.length;t++)if(o[t]&&(e=W(o[t]),s=Math.max(s,e[0]),e[1]&&(n.length>1&&(n+="/"),n+=e[1],2===e[0]))){i=e[2];break}return{pattern:n,wild:i,type:s}}async function A$1(e,t){const r=join(e,t.routes);if(!n$1(r))return[];const{test:n,layout:i}=t,s=new Map,o=e=>i.test(e)&&n.test(e);await totalist(r,(async(e,t)=>{if(/^[._]/.test(e)||!n.test(e))return;const i={..._(relative(r,t)),file:t,layout:null};await w$3(t,((e,t)=>{let r=t.find(o);if(r)return i.layout=join(e,r)})),s.set(i.pattern,i)}));const l=[...s.keys()];return B(l).map((e=>s.get(e)))}async function a(e,t){const r=await x$1(e).then((r=>{let n=d$3(r,/index\.(dom\.)?[tjm]sx?$/);n&&(n=join(e,n));let i=d$3(r,/index\.ssr\.[tjm]sx?$/);i=i?join(e,i):t.ssr.entry;let s=d$3(r,/index\.html(\.(svelte|vue|[tjm]sx?))?$/);return s&&(s=join(e,s)),{dom:n,ssr:i,html:s}}));if(!r.dom)throw new Error('Missing "DOM" entry file!');if(!r.html)throw new Error("Missing HTML template file!");return r}async function S(e,t){const r=[],{test:n,layout:i,errors:s}=t,o=join(e,s);if(!n$1(o))return r;let l,a=!1;const u=e=>i.test(e)&&n.test(e);return await totalist(o,(async(e,t)=>{if(/^[._]/.test(e)||!n.test(e))return;const{name:i}=parse(e);if("xxx"===i&&(a=!0,l))return void(l.file=t);const s={file:t,layout:null,key:i};if("index"===i){if(a)return;s.key="xxx",l=s}await w$3(t,((e,t)=>{let r=t.find(u);if(r)return s.layout=join(e,r)})),r.push(s)})),r}function i$4(e,t){return e=resolve(t||".",e),n$1(e)&&require(e)}function f$2(e,t){return require.resolve(t,{paths:[e,__dirname]})}!function(e){e[e.Static=0]="Static",e[e.Param=1]="Param",e[e.Wild=2]="Wild"}(o$2||(o$2={}));const e$2=new Set;function c(e){if(e$2.size)return e$2;const t=/^@freshie\//i,r=i$4("package.json",e);return r&&Object.keys(Object.assign({},r.dependencies,r.devDependencies)).forEach((e=>t.test(e)&&e$2.add(e))),e$2}const s$2={publicPath:"/",alias:{entries:{"~routes":"","~components":"components","~assets":"","~utils":"utils","~tags":"tags"}},ssr:{type:null,entry:null},templates:{routes:"routes",layout:/^_layout/,test:/\.([tj]sx?|svelte|vue)$/,errors:"errors"},assets:{dir:"assets",test:/\.(svg|woff2?|ttf|eot|jpe?g|png|gif|mp4|mov|ogg|webm)$/},copy:["static","public"],replace:{__DEV__:"true",__BROWSER__:"true","process.browser":"true","process.env.NODE_ENV":"development",__SSR__:"true"},resolve:{extensions:[".mjs",".js",".jsx",".json"],conditions:[],mainFields:["module","jsnext","jsnext:main","main"]},commonjs:{extensions:[".js",".cjs"]},json:{preferConst:!0,namedExports:!0,indent:"  "}};function p$1(e=[]){return{name:"plugins/copy",async generateBundle(){await Promise.all(e.map((e=>n$1(e)&&totalist(e,((e,t)=>{this.emitFile({type:"asset",source:readFileSync(t),fileName:e})})))))}}}function u(e,t){return`<link rel="preload" href="${e}" as="${t}"/>`}function d$1(e){return require("node-html-parser").parse(e)}function i$3(e,t){let r=d$1(t);e.appendChild(r)}function $(e,t={}){const{publicPath:r="/",preload:n=!0,minify:i=!0}=t;return{name:"plugins/html",async generateBundle(t,s){const{format:o}=t,l=new Set;for(let e in s){if(!/\.js$/.test(e))continue;let t=s[e];!t.isEntry||(l.add(e),t.imports.forEach((e=>l.add(e))),t.referencedFiles.forEach((e=>l.add(e))))}let a=d$1(await u$1(e,"utf8"));if(a.querySelectorAll("link,script").forEach((e=>{let{src:t,href:n}=e.rawAttributes;if(/^(https?:)?\/\//.test(n||t))return;let i=n||t;i.startsWith("/")&&(i=i.substring(1)),e.setAttribute(n?"href":"src",r+i)})),l.size>0){const e=a.querySelector("head"),t=a.querySelector("body");for(let i of l)i=r+i,/\.css$/.test(i)?(n&&i$3(e,u(i,"style")),i$3(e,`<link rel="stylesheet" href="${i}"/>`)):/\.m?js$/.test(i)&&(/esm?/.test(o)?(n&&i$3(e,`<link rel="modulepreload" href="${i}"/>`),i$3(t,`<script type="module" src="${i}"><\/script>`),i$3(t,`<script nomodule defer src="https://unpkg.com/dimport/nomodule" data-main="${i}"><\/script>`)):(n&&i$3(e,u(i,"script")),i$3(t,`<script src="${i}"><\/script>`)))}i&&a.removeWhitespace(),this.emitFile({type:"asset",fileName:"index.html",source:a.toString()})}}}const o$1=join(__dirname,"..","env","index.mjs"),l$1=join(__dirname,"..","http","index.mjs"),r$2=join(__dirname,"..","router","index.mjs"),i$2={name:"plugins/router",resolveId:e=>"freshie/router"===e?r$2:null},s$1={name:"plugins/http",resolveId:e=>"freshie/http"===e?l$1:null},p={name:"plugins/env",resolveId:e=>"freshie/env"===e?o$1:null},E=join(__dirname,"..","runtime","index.dom.js");async function R$1(e,t,r,n,i){const s=await u$1(t,"utf8"),o=new Map;let l=0,a="",u="",c="";const p=t=>t.replace(e,"\0src").replace(/[\\\/]+/g,"/");function f(e){let t=e&&o.get(e);return e&&t?t:e&&!t?(o.set(e,t="$Layout"+l++),a+=`import * as ${t} from '${p(e)}';\n`,t):void 0}return r.forEach(((e,t)=>{if(u&&(u+="\n\t"),i){let t=[`import('${p(e.file)}')`];e.layout&&t.unshift(`import('${p(e.layout)}')`),u+=`define('${e.pattern}', () => Promise.all([ ${t} ]));`}else{let r=[`$Route${t}`],n=f(e.layout);n&&r.unshift(n),a+=`import * as $Route${t} from '${p(e.file)}';\n`,u+=`define('${e.pattern}', ${r});`}})),n.forEach(((e,t)=>{if(i){let t=[`import('${p(e.file)}')`];e.layout&&t.unshift(`import('${p(e.layout)}')`),c+=`'${e.key}': () => Promise.all([ ${t} ]),`}else{let r=[`$Error${t}`],n=f(e.layout);n&&r.unshift(n),a+=`import * as $Error${t} from '${p(e.file)}';\n`,c+=`'${e.key}': prepare([${r}]),`}})),a&&(a+="\n"),a+s.replace("/* <ROUTES> */",u).replace("/* <ERRORS> */",c)}function w$2(e,t,r,n){const i="freshie/runtime";return{name:"plugins/runtime",resolveId:t=>n&&t===i?t:t.startsWith("\0src")?join(e,t.replace("\0src","")):void 0,load:s=>s===i?R$1(e,E,t,r,n):/[\\\/]+@freshie[\\\/]+ssr/.test(s)?R$1(e,s,t,r,n):void 0}}const i$1=(e,t)=>n$1(e)||i$5(t);function i(e){const t="!!~html~!!";return{name:"plugins/template",buildStart(){i$1(e,'Cannot find pre-built "index.html" template!')},resolveId:e=>e===t?t:null,load:async r=>r!==t?null:`export const HTML = \`${await u$1(e,"utf8")}\`;`}}const r$1=["B","kB","MB","GB"];function o(e){if(!e)return"0.00 kB";let t=Math.min(Math.floor(Math.log10(e)/3),r$1.length-1)||1,r=(e/Math.pow(1e3,t)).toPrecision(3),n=r.indexOf(".");return-1===n?r+=".00":r.length-n-1!=2&&(r=(r+"00").substring(0,n+3)),r+" "+r$1[t]}function s(e=0){return(e/1e3).toFixed(2)+"s"}const z$1=" ".repeat(2),d=" ".repeat(4),f$1=i$6.dim().bold().italic().underline,h=(e,t)=>e.padEnd(t),r=(e,t)=>e.padStart(t),O=[i$6.cyan,i$6.yellow,i$6.red];let e,e$1={file:0,size:0,gzip:0};function w$1(e={}){const{isDOM:t}=e;let n,i=i$6.bold().underline().green(t?"DOM":"SSR");return{name:"plugins/summary",buildStart(){n=Date.now()},generateBundle(e,l){let a,u=`Compiled ${i} output in ${s(Date.now()-n)}`,c=Object.keys(l).sort().map((e=>{let t=l[e].code||l[e].source,r=o(t.length),n=gzipSync(t).length,i=n>=2e5?2:n>=1e5?1:0;return a={file:e,size:r,gzip:o(n),notice:i},e$1.file=Math.max(e$1.file,e.length),e$1.gzip=Math.max(e$1.gzip,a.gzip.length),e$1.size=Math.max(e$1.size,r.length),a}));t&&(e$1.file+=4,e$1.size+=4),u+="\n\n"+f$1(h("Filename",e$1.file))+d+f$1(r("Filesize",e$1.size))+z$1+i$6.dim().bold().italic(r("(gzip)",e$1.gzip)),c.forEach((e=>{let t=O[e.notice],n=i$6.italic((e.notice?t:i$6.dim)(z$1+r(e.gzip,e$1.gzip)));u+="\n"+i$6.white(h(e.file,e$1.file))+d+t(r(e.size,e$1.size))+n})),d$2(u+"\n")}}}function k(e,t,r){for(let n in t)if("rollup"!==n)if("function"==typeof t[n]){e[n]=e[n]||{};let i=t[n](e[n],r);"string"==typeof e[n]&&"string"==typeof i&&(e[n]=i)}else e[n]=t[n]||e[n]}function q(e,t,r=!1){const n=klona(s$2),{src:i,minify:s,isProd:o,cwd:l,sourcemap:a}=t,u={ssr:r,minify:s,isProd:o,sourcemap:a,src:i,cwd:l};e.forEach((e=>k(n,e,u)));const c=n.alias.entries;c["~assets"]=n.assets.dir,c["~routes"]=n.templates.routes;for(let e in c){let t=c[e];c[e]=resolve(i,t)}return n.copy=n.copy.map((e=>resolve(i,e))),n.replace.__DEV__=String(!o),n.replace["process.env.NODE_ENV"]=JSON.stringify(o?"production":"development"),{options:n,context:u}}async function z(e){const{cwd:t,src:r,isProd:n}=e,i=i$4("freshie.config.js",t),s=[],o=[];let l,u,p;function f(e){l$2(`Applying ${b(e)} preset`);let r=f$2(t,join(e,"config.js")),{rollup:n,...i}=require(r);/[/]ui\./.test(e)&&(p=p||e),n&&o.push(n),s.push(i)}if(c(t).forEach(f),i){l$2(`Applying "${f$3("freshie.config.js")}" config`);let{rollup:e,...t}=i;e&&o.push(e),s.push(t)}l=q(s,e);const{options:$}=l,m=await A$1(r,$.templates);if(!m.length)throw new Error("No routes found!");const d=await S(r,$.templates);p&&!d.find((e=>"xxx"===e.key))&&d.push({file:$.alias.entries["!!~error~!!"],layout:null,key:"xxx"});const h=await a(r,$),y=w(e,m,h,d,l.options,l.context);let g;return e.ssr&&!n?$.ssr.type="node":e.ssr&&!$.ssr.type?(f("@freshie/ssr.node"),e.ssr=!0):e.ssr||($.ssr.type=null),e.ssr&&(u=q(s,e,!0),u.options.ssr.type||(u.options.ssr=$.ssr),p&&(u.options.alias.entries["!!~ui~!!"]=f$2(t,p)),g=A(e,m,h,d,u.options,u.context)),o.forEach((e=>{e(y,l.context,l.options),g&&e(g,u.context,u.options)})),y.plugins.push(w$1({isDOM:!0})),g&&g.plugins.push(w$1({isDOM:!1})),{options:$,client:y,server:g}}function w(e,t,r,n,i,s){const{src:o,isProd:l,minify:a,sourcemap:u}=s;return{input:r.dom,output:{sourcemap:!!u,dir:join(e.dest,"client"),minifyInternalExports:l,entryFileNames:l?"[name].[hash].js":"[name].js",assetFileNames:l?"[name].[hash].[ext]":"[name].[ext]",chunkFileNames:l?"[name].[hash].js":"[name].js"},preserveEntrySignatures:!l&&"strict",treeshake:l&&{moduleSideEffects:"no-external",tryCatchDeoptimization:!1},plugins:[p,s$1,i$2,p$1(i.copy),$(r.html,{...i,minify:a}),w$2(o,t,n,!0),require("@rollup/plugin-alias")(i.alias),require("@rollup/plugin-replace")({...i.replace,__BROWSER__:"true","process.browser":"true",__SSR__:"false"}),require("@rollup/plugin-node-resolve").default({browser:!0,...i.resolve,rootDir:o}),require("@rollup/plugin-json")({compact:l,...i.json}),require("rollup-route-manifest")({merge:!0,inline:!0,headers:!1,filename:!1,routes(e){if(e===r.dom)return"*";for(let r=0;r<t.length;r++)if(t[r].file===e)return t[r].pattern},format:e=>e.map((e=>e.href))}),require("@rollup/plugin-commonjs")(i.commonjs)]}}function A(e,t,r,n,s,o){const{src:l,isProd:a,minify:u,sourcemap:c}=o,f=join(e.dest,"client","index.html");return{input:r.ssr||s.ssr.entry||join(l,"index.ssr.js"),output:{file:join(e.dest,"server","index.js"),minifyInternalExports:a,sourcemap:!!c},treeshake:{propertyReadSideEffects:!1,moduleSideEffects:"no-external",tryCatchDeoptimization:!1},plugins:[p,s$1,i(f),w$2(l,t,n,!1),require("@rollup/plugin-alias")(s.alias),require("@rollup/plugin-replace")({...s.replace,__BROWSER__:"false","process.browser":"false",__SSR__:"true"}),require("@rollup/plugin-node-resolve").default({browser:!1,...s.resolve,rootDir:l}),require("@rollup/plugin-json")({compact:a,...s.json}),require("@rollup/plugin-commonjs")(s.commonjs)]}}async function l(t){return e=e||require("rollup").rollup,e(t).then((e=>e.write(t.output)))}async function f(e){try{m(e,!0);let t=await z(e);n$1(e.dest)&&(x(`Removing "${f$3(e.destDir)}" directory`),await f$4(e.dest)),await l(t.client),t.server&&await l(t.server),d$2("Build complete! 🎉")}catch(e){a$1(e)}}function R(e,t){const{src:r,dest:n}=t,i=require("rollup").watch(e);let s=[],o=new Set;return i.on("change",(e=>{e.startsWith(r)?o.add("/"+relative(r,e)):console.error('[CHANGE] NOT WITHIN SOURCE: "%s"',e)})),i.on("event",(e=>{switch(console.log(e),e.code){case"START":s=[...o],o.clear();break;case"BUNDLE_END":console.info(`Bundled in ${e.duration}ms`);break;case"ERROR":console.error("ERROR",e.error)}})),i}async function n(e){m(e,!1);let t=await z(e).catch(a$1);n$1(e.dest)&&(x(`Removing "${f$3(e.destDir)}" directory`),await f$4(e.dest)),R(t.client,e)}export{f as build,n as watch};
